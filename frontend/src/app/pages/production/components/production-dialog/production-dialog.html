<div class="flex flex-column gap-2 p-fluid p-4">
    <p-steps [model]="items" [(activeIndex)]="currentStep" [readonly]="false" styleClass="mb-5"></p-steps>

    <div *ngIf="!canEditCore && isAssignedUser"
        class="bg-blue-50 border-round p-3 mb-3 flex align-items-center gap-2 text-blue-700">
        <i class="pi pi-info-circle text-xl"></i>
        <span class="font-medium">Modo Restringido: Solo puedes agregar comentarios, archivos, reasignar y actualizar el
            estado.</span>
    </div>

    <form [formGroup]="form" class="flex flex-column gap-2">
        <!-- Step 0: General Request -->
        <div *ngIf="currentStep === 0" class="flex flex-column gap-3">
            <div>
                <p-floatlabel variant="in">
                    <input pInputText id="name" formControlName="name" class="w-full" autocomplete="off"
                        placeholder="Incluya cliente, campaña mes y año" />
                    <label for="name">Nombre de la solicitud</label>
                </p-floatlabel>
                <small class="p-error" *ngIf="form.get('name')?.invalid && form.get('name')?.dirty">
                    Nombre es requerido
                </small>
            </div>



            <div class="formgrid grid">
                <div class="col-12 md:col-12 mb-2">
                    <p-floatlabel variant="in">
                        <p-select id="assignedTeam" formControlName="assignedTeam" [options]="(teams$ | async) ?? []"
                            optionLabel="name" optionValue="name" [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label for="assignedTeam">Area asignada</label>
                    </p-floatlabel>
                    <small class="p-error" *ngIf="form.get('assignedTeam')?.invalid && form.get('assignedTeam')?.dirty">
                        Equipo es requerido
                    </small>
                </div>
            </div>

            <div class="mb-2">
                <p-floatlabel variant="in">
                    <ng-container *ngIf="!form.get('deliveryDate')?.disabled">
                        <p-datepicker id="deliveryDate" formControlName="deliveryDate" dateFormat="yy-mm-dd"
                            [showIcon]="true" appendTo="body" styleClass="w-full" inputStyleClass="w-full"
                            [minDate]="minDate" [showTime]="true" hourFormat="12"></p-datepicker>
                    </ng-container>
                    <input *ngIf="form.get('deliveryDate')?.disabled" pInputText id="deliveryDate"
                        [value]="form.get('deliveryDate')?.value | date:'yyyy-MM-dd hh:mm a'" class="w-full" disabled />
                    <label for="deliveryDate">Fecha de entrega</label>
                </p-floatlabel>
                <small class="p-error" *ngIf="form.get('deliveryDate')?.invalid && form.get('deliveryDate')?.dirty">
                    Fecha es requerida
                </small>
            </div>

            <div class="mb-2">
                <p-floatlabel variant="in">
                    <p-select id="statusId" formControlName="statusId" [options]="workflowStages" optionLabel="label"
                        optionValue="id" [style]="{'width':'100%'}" appendTo="body"></p-select>
                    <label for="statusId">Estado</label>
                </p-floatlabel>
            </div>

            <div>
                <p-floatlabel variant="in">
                    <textarea pTextarea id="observations" formControlName="observations" rows="3"
                        autoResize="autoResize" class="w-full"></textarea>
                    <label for="observations">Observaciones</label>
                </p-floatlabel>
            </div>

            <div>
                <label class="font-bold mb-2 block">Archivos adjuntos</label>
                <p-fileUpload mode="advanced" name="demo[]" [customUpload]="true" [showUploadButton]="false"
                    [showCancelButton]="true" (onSelect)="onFileSelect($event)" (onRemove)="onFileRemove($event)"
                    (onClear)="onFileClear()" [multiple]="true" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx"
                    [maxFileSize]="10000000" chooseLabel="Seleccionar" cancelLabel="Cancelar"
                    [disabled]="!canEditCore && !isAssignedUser">
                </p-fileUpload>

                <div *ngIf="existingFiles.length > 0" class="mt-3">
                    <div *ngFor="let file of existingFiles"
                        class="flex align-items-center justify-content-between p-2 border-round mb-2">
                        <div class="flex align-items-center gap-2 cursor-pointer hover:surface-100 p-1 border-round transition-colors"
                            (click)="downloadFile(file)" pTooltip="Descargar" tooltipPosition="top">
                            <i class="pi pi-file text-primary"></i>
                            <span class="text-sm font-medium">{{file.name}}</span>
                            <i class="pi pi-download text-xs text-600"></i>
                        </div>
                        <button *ngIf="canEditCore || isAssignedUser" pButton icon="pi pi-times"
                            class="p-button-text p-button-danger p-button-sm p-0 w-2rem h-2rem"
                            (click)="removeFile(file)" pTooltip="Eliminar" tooltipPosition="left"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Customer Information (Moved from Step 2) -->
        <div *ngIf="currentStep === 1" formGroupName="customerData" class="flex flex-column gap-3">
            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="clientAgency" class="w-full" />
                        <label>Cliente / Agencia</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="requesterName" class="w-full" />
                        <label>Nombre del Solicitante</label>
                    </p-floatlabel>
                </div>
            </div>

            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="requesterEmail" class="w-full" />
                        <label>Email del Solicitante</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="requesterPhone" class="w-full" />
                        <label>Teléfono del Solicitante</label>
                    </p-floatlabel>
                </div>
            </div>

            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="businessName" class="w-full" />
                        <label>Razón Social</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="nit" class="w-full" />
                        <label>NIT</label>
                    </p-floatlabel>
                </div>
            </div>

            <label class="font-bold">Estrategia de Servicio / Tácticas</label>
            <div class="flex flex-wrap gap-3">
                <div class="flex align-items-center">
                    <p-checkbox formControlName="serviceStrategy" [binary]="true" label="Estrategia"></p-checkbox>
                </div>
                <div class="flex align-items-center">
                    <p-checkbox formControlName="serviceTactical" [binary]="true" label="Táctica"></p-checkbox>
                </div>
                <div class="flex align-items-center">
                    <p-checkbox formControlName="serviceProduction" [binary]="true" label="Producción"></p-checkbox>
                </div>
                <div class="flex align-items-center">
                    <p-checkbox formControlName="serviceData" [binary]="true" label="Datos"></p-checkbox>
                </div>
            </div>
        </div>

        <!-- Step 2: Campaign Details -->
        <div *ngIf="currentStep === 2" formGroupName="campaignDetail" class="flex flex-column gap-3">
            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="budget" class="w-full" />
                        <label>Presupuesto</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="brand" class="w-full" />
                        <label>Marca</label>
                    </p-floatlabel>
                </div>
            </div>

            <p-floatlabel variant="in">
                <input pInputText formControlName="productService" class="w-full" />
                <label>Nombre del Producto / Servicio</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <p-select formControlName="objectiveId" [options]="campaignObjectives" optionLabel="name"
                    optionValue="id" [style]="{'width':'100%'}" appendTo="body"></p-select>
                <label>Objetivo de la Campaña</label>
            </p-floatlabel>

            <div class="flex flex-column gap-2 mt-3">
                <div class="flex justify-content-between align-items-center">
                    <label class="font-bold">Productos y Cantidades</label>
                    <button pButton icon="pi pi-plus" label="Agregar Producto" class="p-button-sm p-button-outlined"
                        (click)="addCampaignProduct()"></button>
                </div>

                <div formArrayName="campaignProducts" class="flex flex-column gap-2">
                    <div *ngFor="let product of campaignProducts.controls; let i = index" [formGroupName]="i"
                        class="flex gap-2 align-items-center">
                        <div class="flex-1">
                            <p-floatlabel variant="in">
                                <p-select formControlName="productId" [options]="(products$ | async) ?? []"
                                    optionLabel="name" optionValue="id" [style]="{'width':'100%'}"
                                    appendTo="body"></p-select>
                                <label>Producto</label>
                            </p-floatlabel>
                        </div>
                        <div class="w-8rem">
                            <p-floatlabel variant="in">
                                <input pInputText formControlName="quantity" class="w-full" />
                                <label>Cantidad</label>
                            </p-floatlabel>
                        </div>
                        <button pButton icon="pi pi-trash" class="p-button-danger p-button-text"
                            (click)="removeCampaignProduct(i)"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Audience Details -->
        <div *ngIf="currentStep === 3" formGroupName="audienceData" class="flex flex-column gap-3">
            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <p-select formControlName="genderId" [options]="genders" optionLabel="name" optionValue="id"
                            [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label>Género</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <input pInputText formControlName="geo" class="w-full" />
                        <label>Geo (Ubicación)</label>
                    </p-floatlabel>
                </div>
            </div>

            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <p-select formControlName="ageRangeId" [options]="ageRanges" optionLabel="name" optionValue="id"
                            [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label>Rango de Edad</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <p-select formControlName="socioEconomicLevelId" [options]="socioeconomicLevels"
                            optionLabel="name" optionValue="id" [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label>Nivel Socioeconómico (NSE)</label>
                    </p-floatlabel>
                </div>
            </div>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="interests" rows="2" class="w-full"></textarea>
                <label>Intereses</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="specificDetails" rows="2" class="w-full"></textarea>
                <label>Detalles Específicos</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="campaignContext" rows="2" class="w-full"></textarea>
                <label>Contexto de la Campaña</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="campaignConcept" rows="2" class="w-full"></textarea>
                <label>Concepto de la Campaña</label>
            </p-floatlabel>
            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="assets" rows="2" class="w-full"></textarea>
                <label>Activos</label>
            </p-floatlabel>
        </div>

        <!-- Step 4: Production & Formats -->
        <div *ngIf="currentStep === 4" formGroupName="productionInfo" class="flex flex-column gap-3">
            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <p-select formControlName="formatTypeId" [options]="formatTypes" optionLabel="name"
                            optionValue="id" [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label>Tipo de Formato</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <p-select formControlName="rightsDurationId" [options]="rightsDurations" optionLabel="name"
                            optionValue="id" [style]="{'width':'100%'}" appendTo="body"></p-select>
                        <label>Derechos / Duración</label>
                    </p-floatlabel>
                </div>
            </div>

            <div class="mb-2">
                <p-floatlabel variant="in">
                    <ng-container *ngIf="!form.get('productionInfo.campaignEmissionDate')?.disabled">
                        <p-datepicker formControlName="campaignEmissionDate" dateFormat="yy-mm-dd" [showIcon]="true"
                            appendTo="body" styleClass="w-full" inputStyleClass="w-full" [showTime]="true"
                            hourFormat="12"></p-datepicker>
                    </ng-container>
                    <input *ngIf="form.get('productionInfo.campaignEmissionDate')?.disabled" pInputText
                        [value]="form.get('productionInfo.campaignEmissionDate')?.value | date:'yyyy-MM-dd hh:mm a'"
                        class="w-full" disabled />
                    <label>Fecha de Emisión de Campaña</label>
                </p-floatlabel>
            </div>

            <p-floatlabel variant="in">
                <input pInputText formControlName="communicationTone" class="w-full" />
                <label>Tono de Comunicación</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="ownAndExternalMedia" rows="2" class="w-full"></textarea>
                <label>Medios Propios y Externos</label>
            </p-floatlabel>

            <div class="formgrid grid">
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <textarea pTextarea formControlName="tvFormats" rows="2" class="w-full"></textarea>
                        <label>Formatos TV</label>
                    </p-floatlabel>
                </div>
                <div class="col-12 md:col-6">
                    <p-floatlabel variant="in">
                        <textarea pTextarea formControlName="digitalFormats" rows="2" class="w-full"></textarea>
                        <label>Formatos Digitales</label>
                    </p-floatlabel>
                </div>
            </div>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="productionDetails" rows="3" class="w-full"></textarea>
                <label>Detalles de Producción</label>
            </p-floatlabel>

            <p-floatlabel variant="in">
                <textarea pTextarea formControlName="additionalComments" rows="3" class="w-full"></textarea>
                <label>Comentarios Adicionales</label>
            </p-floatlabel>
        </div>

    </form>

    <div class="flex justify-content-between gap-2 mt-4">
        <button pButton label="Cancelar" icon="pi pi-times" class="p-button-text p-button-danger"
            (click)="cancel()"></button>

        <div class="flex gap-2">
            <button *ngIf="currentStep > 0" pButton label="Atrás" icon="pi pi-arrow-left" class="p-button-outlined"
                (click)="prev()"></button>
            <button *ngIf="currentStep < 4" pButton label="Siguiente" icon="pi pi-arrow-right"
                (click)="next()"></button>
            <button *ngIf="currentStep === 4" pButton label="Guardar" icon="pi pi-check" (click)="save()"
                [loading]="(isUploading$ | async) ?? false"></button>
        </div>
    </div>
</div>