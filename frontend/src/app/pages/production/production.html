<div class="card">
    <div class="flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="text-3xl font-bold m-0 mb-2">Gesti칩n de Producci칩n</h1>
            <span class="text-color-secondary">Seguimiento de solicitudes en el flujo de producci칩n</span>
        </div>
        <p-button label="Nueva Solicitud" icon="pi pi-plus" (click)="openDialog()"></p-button>
    </div>

    <div class="grid">
        <div *ngFor="let request of requests()" class="col-12 md:col-6 lg:col-4 xl:col-3">
            <p-card [style]="{ height: '100%', display: 'flex', flexDirection: 'column' }"
                styleClass="flex flex-column h-full shadow-2 hover:shadow-6 transition-duration-200">
                <ng-template pTemplate="header">
                    <div class="flex justify-content-between align-items-start p-3 pb-0">
                        <h3 class="text-xl font-bold m-0 text-overflow-ellipsis overflow-hidden white-space-nowrap flex-1 mr-2"
                            [pTooltip]="request.name">{{ request.name }}</h3>
                        <p-tag [value]="getStageLabel(request.stage)"
                            [severity]="getStageSeverity(request.stage)"></p-tag>
                    </div>
                </ng-template>

                <div class="flex flex-column gap-3 p-3 pt-0 flex-grow-1">
                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-calendar"></i>
                        <span>Solicitado: {{ request.requestDate | date:'dd/MM/yyyy' }}</span>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-user"></i>
                        <div class="flex flex-column">
                            <span>Dep: {{ request.department }}</span>
                            <span>Contacto: {{ request.contactPerson }}</span>
                        </div>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-users"></i>
                        <span>Equipo: {{ request.assignedTeam }}</span>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600" *ngIf="request.deliveryDate">
                        <i class="pi pi-calendar-plus"></i>
                        <span>Entrega: {{ request.deliveryDate | date:'dd/MM/yyyy' }}</span>
                    </div>

                    <div *ngIf="request.files && request.files.length > 0" class="mt-2">
                        <div class="text-sm font-bold mb-1">Archivos adjuntos ({{ request.files.length }}):</div>
                        <div class="flex flex-column gap-1">
                            <div *ngFor="let file of request.files.slice(0, 3)"
                                class="flex align-items-center justify-content-between surface-100 p-1 border-round text-xs">
                                <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap"
                                    style="max-width: 150px;" [pTooltip]="file.name">{{ file.name }}</span>
                                <div class="flex">
                                    <p-button icon="pi pi-eye" [rounded]="true" [text]="true" size="small"
                                        (click)="openPreview(file)" pTooltip="Vista Previa"></p-button>
                                    <p-button icon="pi pi-download" [rounded]="true" [text]="true" size="small"
                                        (click)="downloadFile(file.id, file.name)" pTooltip="Descargar"></p-button>
                                </div>
                            </div>
                            <div *ngIf="request.files.length > 3" class="text-xs text-500 font-italic pl-1">
                                +{{ request.files.length - 3 }} archivos m치s
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2 border-top-1 surface-border pt-3 mt-auto">
                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" pTooltip="Editar"
                            (click)="openDialog(request)"></p-button>
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                            pTooltip="Eliminar" (click)="deleteRequest(request.id)"></p-button>

                        <p-button *ngIf="request.stage !== 'completed'" icon="pi pi-arrow-right" [rounded]="true"
                            [text]="true" severity="success" pTooltip="Avanzar etapa"
                            (click)="moveRequest(request)"></p-button>
                    </div>
                </ng-template>
            </p-card>
        </div>
    </div>
</div>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<app-file-preview [(visible)]="previewVisible" [file]="previewFile()" (onDownload)="downloadPreviewFile()">
</app-file-preview>