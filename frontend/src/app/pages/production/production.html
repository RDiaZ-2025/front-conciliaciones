<div class="flex flex-column gap-4 p-4 fadein animation-duration-300">
    <app-page-header [title]="showHistorical() ? 'Histórico de Producción' : 'Gestión de Producción'"
        [subtitle]="showHistorical() ? 'Registro de solicitudes completadas y entregadas' : 'Seguimiento de solicitudes en el flujo de producción'"
        [icon]="showHistorical() ? 'pi pi-history' : 'pi pi-cog'">
        <div class="flex gap-2">
            <p-button *ngIf="!showHistorical()" label="Reglas SLA" icon="pi pi-info-circle" [outlined]="true"
                (click)="slaRulesVisible.set(true)"></p-button>
            <p-button *ngIf="!showHistorical()" label="Histórico" icon="pi pi-history" [outlined]="true"
                (click)="showHistorical.set(true)"></p-button>
            <p-button *ngIf="showHistorical()" label="Volver al Tablero" icon="pi pi-arrow-left" [outlined]="true"
                (click)="showHistorical.set(false)"></p-button>
            <p-button *ngIf="!showHistorical()" label="Nueva Solicitud" icon="pi pi-plus"
                (click)="openDialog()"></p-button>
        </div>
    </app-page-header>

    <div class="grid" *ngIf="!showHistorical()">
        <div *ngFor="let request of activeRequests()" class="col-12 md:col-6 lg:col-4 xl:col-3">
            <p-card [style]="{ height: '100%', display: 'flex', flexDirection: 'column' }"
                styleClass="flex flex-column h-full shadow-2 hover:shadow-6 transition-duration-200">
                <ng-template pTemplate="header">
                    <div class="flex justify-content-between align-items-start p-3 pb-0">
                        <h3 class="text-xl font-bold m-0 text-overflow-ellipsis overflow-hidden white-space-nowrap flex-1 mr-2"
                            [pTooltip]="request.name">{{ request.name }}</h3>
                        <p-tag [value]="getStageLabel(request.stage)"
                            [severity]="getStageSeverity(request.stage)"></p-tag>
                    </div>
                </ng-template>

                <div class="flex flex-column gap-3 p-3 pt-0 flex-grow-1">
                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-calendar"></i>
                        <span>Solicitado: {{ request.requestDate | date:'dd/MM/yyyy' }}</span>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-user"></i>
                        <div class="flex flex-column">
                            <span>Dep: {{ request.department }}</span>
                            <span>Contacto: {{ request.contactPerson }}</span>
                        </div>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600">
                        <i class="pi pi-users"></i>
                        <span>Equipo: {{ request.assignedTeam }}</span>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm text-600" *ngIf="request.deliveryDate">
                        <i class="pi pi-calendar-plus"></i>
                        <span>Entrega: {{ request.deliveryDate | date:'dd/MM/yyyy hh:mm a' }}</span>
                    </div>

                    <div class="flex align-items-center gap-2 text-sm mt-1"
                        *ngIf="request.deliveryDate && request.stage !== 'completed'">
                        <i class="pi pi-clock" [ngClass]="{
                            'text-green-500': getSLAStatus(request.deliveryDate) === 'success',
                            'text-yellow-500': getSLAStatus(request.deliveryDate) === 'warn',
                            'text-red-500': getSLAStatus(request.deliveryDate) === 'danger'
                        }"></i>
                        <span [ngClass]="{
                            'text-green-500': getSLAStatus(request.deliveryDate) === 'success',
                            'text-yellow-500': getSLAStatus(request.deliveryDate) === 'warn',
                            'text-red-500': getSLAStatus(request.deliveryDate) === 'danger'
                        }" class="font-bold">
                            {{ getRemainingTime(request.deliveryDate) }}
                        </span>
                    </div>

                    <div *ngIf="request.files && request.files.length > 0" class="mt-2">
                        <div class="text-sm font-bold mb-1">Archivos adjuntos ({{ request.files.length }}):</div>
                        <div class="flex flex-column gap-1">
                            <div *ngFor="let file of request.files.slice(0, 3)"
                                class="flex align-items-center justify-content-between surface-100 p-1 border-round text-xs">
                                <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap"
                                    style="max-width: 150px;" [pTooltip]="file.name">{{ file.name }}</span>
                                <div class="flex">
                                    <p-button icon="pi pi-eye" [rounded]="true" [text]="true" size="small"
                                        (click)="openPreview(file)" pTooltip="Vista Previa"></p-button>
                                    <p-button icon="pi pi-download" [rounded]="true" [text]="true" size="small"
                                        (click)="downloadFile(file.id, file.name)" pTooltip="Descargar"></p-button>
                                </div>
                            </div>
                            <div *ngIf="request.files.length > 3" class="text-xs text-500 font-italic pl-1">
                                +{{ request.files.length - 3 }} archivos más
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2 border-top-1 surface-border pt-3 mt-auto">
                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" pTooltip="Editar"
                            (click)="openDialog(request)"></p-button>
                        <p-button icon="pi pi-history" [rounded]="true" [text]="true" severity="help" pTooltip="Historial de Cambios"
                            (click)="openHistory(request)"></p-button>
                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                            pTooltip="Eliminar" (click)="deleteRequest(request.id)"></p-button>

                        <p-button *ngIf="request.stage !== 'completed'" icon="pi pi-arrow-right" [rounded]="true"
                            [text]="true" severity="success" pTooltip="Avanzar etapa"
                            (click)="moveRequest(request)"></p-button>
                    </div>
                </ng-template>
            </p-card>
        </div>
    </div>

    <!-- Historical View -->
    <div class="grid" *ngIf="showHistorical()">
        <div class="col-12 text-center p-5" *ngIf="historicalRequests().length === 0">
            <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
            <h3 class="text-700 m-0">No hay solicitudes en el histórico</h3>
            <p class="text-500">Las solicitudes completadas aparecerán aquí.</p>
        </div>

        <div *ngFor="let request of historicalRequests()" class="col-12 md:col-6 lg:col-4 xl:col-3">
            <div class="surface-card p-3 shadow-1 border-round cursor-pointer hover:shadow-3 transition-duration-200 border-1 surface-border flex align-items-center justify-content-between h-full"
                (click)="openDetailDialog(request)" pRipple>
                <div class="flex align-items-center gap-2 overflow-hidden">
                    <i class="pi pi-file text-primary text-xl"></i>
                    <span class="font-medium text-lg text-900 text-overflow-ellipsis overflow-hidden white-space-nowrap" 
                         [pTooltip]="request.name">{{ request.name }}</span>
                </div>
                <i class="pi pi-external-link text-400"></i>
            </div>
        </div>
    </div>

    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <app-file-preview [(visible)]="previewVisible" [file]="previewFile()" (onDownload)="downloadPreviewFile()">
    </app-file-preview>

    <app-ans-dialog [(visible)]="slaRulesVisible"></app-ans-dialog>
</div>