<div class="flex flex-column gap-4 p-4 fadein animation-duration-300">
    <app-page-header title="Programación de Campañas" subtitle="Gestión y programación de campañas publicitarias"
        icon="pi pi-calendar-plus">
        <div class="flex gap-2 align-items-center">
            <span class="font-bold mr-2">Hora Actual: {{ currentTime() | date:'shortTime' }}</span>
            <p-tag [value]="currentSlot().label" [severity]="getSlotBadgeSeverity(currentSlot().label)"></p-tag>
        </div>
    </app-page-header>

    <div class="grid">
        <div class="col-12 col-custom-70">
            <p-card styleClass="shadow-2">
                <ng-template pTemplate="header">
                    <div
                        class="p-3 border-bottom-1 surface-border flex justify-content-between align-items-center bg-bluegray-50 border-round-top">
                        <span class="font-bold text-lg text-900">Creación de Campaña</span>
                        <span *ngIf="isLocked()" class="text-red-500 font-bold flex align-items-center gap-2">
                            <i class="pi pi-lock"></i> CERRADA - Fuera de Horario
                        </span>
                        <span *ngIf="!isLocked()" class="text-green-500 font-bold flex align-items-center gap-2">
                            <i class="pi pi-lock-open"></i> ABIERTA
                        </span>
                    </div>
                </ng-template>

                <form [formGroup]="campaignForm" (ngSubmit)="onSubmit()" class="flex flex-column gap-2 pt-3">

                    <!-- Top Row -->
                    <div class="formgrid grid">
                        <div class="field col-12 md:col-4">
                            <p-floatlabel variant="in">
                                <input pInputText id="name" formControlName="name" class="w-full" />
                                <label for="name">Nombre de la Campaña</label>
                            </p-floatlabel>
                            <small class="text-red-500"
                                *ngIf="campaignForm.get('name')?.invalid && campaignForm.get('name')?.touched">
                                Nombre es requerido
                            </small>
                        </div>
                        <div class="field col-12 md:col-4">
                            <p-floatlabel variant="in">
                                <p-select formControlName="area" [options]="teams()" optionLabel="name" optionValue="id"
                                    styleClass="w-full" appendTo="body" [showClear]="true"></p-select>
                                <label>Área Asignada</label>
                            </p-floatlabel>
                            <small class="text-red-500"
                                *ngIf="campaignForm.get('area')?.invalid && campaignForm.get('area')?.touched">
                                Área es requerida
                            </small>
                        </div>
                        <div class="field col-12 md:col-4">
                            <p-floatlabel variant="in">
                                <input pInputText formControlName="slot" class="w-full" readonly />
                                <label>Slot de Ejecución</label>
                            </p-floatlabel>
                        </div>
                    </div>

                    <!-- Copy Section -->
                    <div class="field">
                        <p-floatlabel variant="in">
                            <textarea pTextarea formControlName="copy" rows="4" class="w-full"
                                [maxlength]="260"></textarea>
                            <label>Copy (Contenido)</label>
                        </p-floatlabel>
                        <div class="flex justify-content-between mt-1">
                            <small class="text-red-500" *ngIf="campaignForm.get('copy')?.errors?.['specialChars']">
                                No se permiten caracteres especiales.
                            </small>
                            <small class="text-red-500"
                                *ngIf="campaignForm.get('copy')?.errors?.['required'] && campaignForm.get('copy')?.touched">
                                El contenido es requerido.
                            </small>
                            <small class="ml-auto text-600 font-mono">
                                {{ campaignForm.get('copy')?.value?.length || 0 }} / 260
                            </small>
                        </div>
                    </div>

                    <!-- URL Section -->
                    <div class="field">
                        <div class="p-inputgroup flex w-full">
                            <p-floatlabel variant="in" class="flex-1">
                                <input pInputText formControlName="url" class="w-full" />
                                <label>URL de Destino</label>
                            </p-floatlabel>
                            <button type="button" pButton label="Validar Link" icon="pi pi-external-link"
                                class="p-button-outlined flex-none" (click)="validateUrl()"></button>
                        </div>
                        <small class="text-red-500"
                            *ngIf="campaignForm.get('url')?.errors?.['invalidUrl'] && campaignForm.get('url')?.touched">
                            La URL no es válida.
                        </small>
                    </div>

                    <!-- Dates -->
                    <div class="formgrid grid">
                        <div class="field col-12 md:col-6">
                            <p-floatlabel variant="in">
                                <p-datepicker formControlName="startDate" [showIcon]="true" appendTo="body"
                                    styleClass="w-full" inputStyleClass="w-full"></p-datepicker>
                                <label>Fecha de Inicio</label>
                            </p-floatlabel>
                        </div>
                        <div class="field col-12 md:col-6">
                            <p-floatlabel variant="in">
                                <p-datepicker formControlName="endDate" [showIcon]="true" appendTo="body"
                                    styleClass="w-full" inputStyleClass="w-full"></p-datepicker>
                                <label>Fecha de Fin</label>
                            </p-floatlabel>
                            <small class="text-red-500"
                                *ngIf="campaignForm.errors?.['dateRange'] && campaignForm.get('endDate')?.touched">
                                La fecha de fin debe ser posterior a la fecha de inicio.
                            </small>
                        </div>
                    </div>

                    <!-- Impact Distribution -->
                    <div class="field border-1 surface-border border-round p-3">
                        <div class="flex justify-content-between align-items-center mb-3">
                            <label class="font-bold text-900">Distribución de Impactos</label>
                            <button type="button" pButton icon="pi pi-plus" label="Agregar Fecha"
                                class="p-button-sm p-button-outlined" (click)="addImpactRow()"
                                [disabled]="isLocked()"></button>
                        </div>

                        <p-table [value]="impacts.controls" styleClass="p-datatable-sm">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cantidad</th>
                                    <th style="width: 4rem"></th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-control let-i="rowIndex">
                                <tr [formGroup]="$any(control)">
                                    <td>
                                        <p-datepicker formControlName="date" appendTo="body" [showIcon]="false"
                                            styleClass="w-full" inputStyleClass="w-full p-inputtext-sm"></p-datepicker>
                                    </td>
                                    <td>
                                        <input pInputText type="number" formControlName="quantity"
                                            class="w-full p-inputtext-sm" placeholder="Cantidad" />
                                    </td>
                                    <td>
                                        <button type="button" pButton icon="pi pi-trash"
                                            class="p-button-text p-button-danger p-button-sm"
                                            (click)="removeImpactRow(i)" [disabled]="isLocked()"></button>
                                    </td>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="3" class="text-center p-3 text-500">No hay impactos definidos. Agregue
                                        una fecha.</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>

                    <div class="flex justify-content-end">
                        <button pButton type="submit" label="Programar Campaña" icon="pi pi-check"
                            [disabled]="campaignForm.invalid || isLocked()"></button>
                    </div>
                </form>
            </p-card>
        </div>

        <!-- Traceability -->
        <div class="col-12 col-custom-30">
            <p-card styleClass="shadow-2" header="Trazabilidad de Ejecución">
                <p-table [value]="traceabilityData()" [rows]="5" [paginator]="true" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Evento</th>
                            <th>Usuario</th>
                            <th>Detalles</th>
                            <th>Estado</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-log>
                        <tr style="cursor: pointer" (click)="viewDetails(log.data)" pTooltip="Ver detalles" tooltipPosition="top">
                            <td>{{ log.date | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                            <td>{{ log.user }}</td>
                            <td>{{ log.details }}</td>
                            <td><p-tag [value]="log.status" severity="info"></p-tag></td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>
</div>

<p-dialog [visible]="detailsVisible()" (visibleChange)="detailsVisible.set($event)" [header]="'Detalles de la Campaña'" [modal]="true" [style]="{width: '50vw'}" [draggable]="false" [resizable]="false">
    <div *ngIf="selectedCampaign() as campaign" class="flex flex-column gap-3">
        <div class="grid">
            <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">Nombre de la Campaña</span>
                <span class="font-medium text-lg">{{campaign.name}}</span>
            </div>
            <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">Área Asignada</span>
                <span class="font-medium text-lg">{{campaign.team?.name || campaign.teamId}}</span>
            </div>
            <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">Slot de Ejecución</span>
                <span class="font-medium">{{campaign.slot}}</span>
            </div>
             <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">URL de Destino</span>
                <a [href]="campaign.url" target="_blank" class="text-primary font-medium hover:underline flex align-items-center gap-1">
                    {{campaign.url}} <i class="pi pi-external-link text-xs"></i>
                </a>
            </div>
            <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">Fecha de Inicio</span>
                <span class="font-medium"><i class="pi pi-calendar mr-2 text-primary"></i>{{campaign.startDate | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="col-12 md:col-6">
                <span class="text-500 block mb-1 text-sm">Fecha de Fin</span>
                <span class="font-medium"><i class="pi pi-calendar mr-2 text-primary"></i>{{campaign.endDate | date:'dd/MM/yyyy'}}</span>
            </div>
        </div>

        <div>
            <span class="text-500 block mb-2 text-sm">Copy (Contenido)</span>
            <div class="p-3 surface-50 border-1 surface-border border-round font-italic text-700" style="white-space: pre-wrap;">{{campaign.copy}}</div>
        </div>

        <div>
             <span class="text-500 block mb-2 text-sm">Distribución de Impactos</span>
             <p-table [value]="campaign.impacts" styleClass="p-datatable-sm p-datatable-gridlines">
                <ng-template pTemplate="header">
                    <tr>
                        <th class="bg-primary-50">Fecha</th>
                        <th class="bg-primary-50">Cantidad</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-impact>
                    <tr>
                        <td>{{impact.date | date:'dd/MM/yyyy'}}</td>
                        <td class="font-bold">{{impact.quantity | number}}</td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="2" class="text-center p-3 text-500">No hay impactos registrados.</td>
                    </tr>
                </ng-template>
             </p-table>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cerrar" icon="pi pi-times" (click)="detailsVisible.set(false)" [text]="true" severity="secondary"></p-button>
    </ng-template>
</p-dialog>