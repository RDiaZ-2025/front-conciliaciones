<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="flex flex-column gap-4 p-4" style="max-width: 1400px; margin: 0 auto;">
  <!-- Header Section -->
  <div class="flex align-items-center gap-3">
    <div class="flex align-items-center justify-content-center border-round bg-primary text-white"
      style="width: 48px; height: 48px;">
      <i class="pi pi-shield text-2xl"></i>
    </div>
    <div class="flex flex-column">
      <h1 class="m-0 text-3xl font-medium">Panel de Administración</h1>
      <p class="m-0 text-secondary mt-1">Gestión avanzada de usuarios y permisos</p>
    </div>
  </div>

  <!-- Active Session Card -->
  <p-card styleClass="border-round-2xl surface-card shadow-1">
    <div class="flex align-items-center gap-4">
      <div class="flex align-items-center justify-content-center p-3 border-round-xl surface-100">
        <i class="pi pi-user text-primary text-xl"></i>
      </div>
      <div class="flex flex-column">
        <h3 class="m-0 text-lg font-medium mb-1">Sesión Activa</h3>
        <p class="m-0 text-600">Conectado como <strong class="text-900">{{ currentUser()?.name }}</strong> ({{
          currentUser()?.email }})</p>
      </div>
    </div>
  </p-card>

  <!-- User Management Section -->
  <div class="card border-round-2xl shadow-1 surface-card overflow-hidden">
    <!-- Toolbar -->
    <p-toolbar styleClass="border-none border-bottom-1 surface-border p-4 bg-transparent">
      <div class="p-toolbar-group-start flex flex-column align-items-start">
        <h2 class="m-0 text-2xl font-medium mb-1">Gestión de Usuarios</h2>
        <p class="m-0 text-600">Administra usuarios y sus permisos del sistema</p>
      </div>
      <div class="p-toolbar-group-end gap-3 flex-wrap">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
          <input pInputText type="text" [formControl]="searchControl" placeholder="Buscar usuario..."
            class="w-full sm:w-20rem" />
        </p-iconField>
        <p-button label="Nuevo Usuario" icon="pi pi-plus" (onClick)="openUserDialog()"></p-button>
      </div>
    </p-toolbar>

    <!-- Table -->
    <p-table #dt [value]="users" [loading]="loading()" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[5, 10, 25]"
      [globalFilterFields]="['name', 'email']" [filterDelay]="0" styleClass="p-datatable-lg" responsiveLayout="scroll">

      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="name">Usuario <p-sortIcon field="name"></p-sortIcon></th>
          <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
          <th>Permisos</th>
          <th pSortableColumn="status" class="text-center">Estado <p-sortIcon field="status"></p-sortIcon></th>
          <th class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user>
        <tr>
          <td>
            <div class="flex align-items-center gap-3">
              <div class="flex align-items-center justify-content-center p-2 border-round bg-primary-50 text-primary">
                <i class="pi pi-user"></i>
              </div>
              <span class="font-medium">{{ user.name }}</span>
            </div>
          </td>
          <td class="text-600">{{ user.email }}</td>
          <td>
            <div class="flex flex-wrap gap-2">
              <p-tag *ngFor="let perm of user.permissions" [value]="getPermissionLabel(perm)"
                [severity]="getPermissionSeverity(perm)" [rounded]="true">
              </p-tag>
              <span *ngIf="!user.permissions || user.permissions.length === 0" class="text-500 italic text-sm">Sin
                permisos</span>
            </div>
          </td>
          <td class="text-center">
            <p-tag [value]="user.status === 1 ? 'Activo' : 'Inactivo'"
              [severity]="user.status === 1 ? 'success' : 'danger'" [rounded]="true">
            </p-tag>
          </td>
          <td class="text-center">
            <div class="flex justify-content-center gap-2">
              <p-button icon="pi pi-pencil" (onClick)="openUserDialog(user)" pTooltip="Editar usuario"
                tooltipPosition="top" [rounded]="true" [text]="true" severity="primary">
              </p-button>
              <p-button [icon]="user.status === 1 ? 'pi pi-ban' : 'pi pi-check-circle'"
                (onClick)="toggleUserStatus(user)" [pTooltip]="user.status === 1 ? 'Desactivar' : 'Activar'"
                tooltipPosition="top" [rounded]="true" [text]="true"
                [severity]="user.status === 1 ? 'warn' : 'success'">
              </p-button>
              <p-button icon="pi pi-history" (onClick)="viewHistory(user)" pTooltip="Ver historial"
                tooltipPosition="top" [rounded]="true" [text]="true" severity="info">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center p-4 text-600">
            No se encontraron usuarios que coincidan con la búsqueda.
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>