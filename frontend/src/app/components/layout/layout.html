<div class="layout-wrapper min-h-screen flex flex-column surface-ground">
   <p-toolbar styleClass="fixed top-0 left-0 right-0 z-5 border-none shadow-2 px-4 py-2 flex justify-content-between align-items-center" [style]="{'height': '4rem'}">
      <div class="p-toolbar-group-start flex align-items-center gap-2">
         <p-button icon="pi pi-bars" [text]="true" [rounded]="true" (click)="toggleDrawer()"
            styleClass="text-900 w-3rem h-3rem"></p-button>
         <img src="assets/claro-media-logo.png" alt="Logo" class="h-2rem ml-2">
      </div>
      <div class="p-toolbar-group-end flex align-items-center gap-3">
         <!-- Notification Icon -->
         <div class="relative flex align-items-center">
            <p-button icon="pi pi-bell" [text]="true" [rounded]="true" (click)="op.toggle($event)"
               styleClass="text-900 w-3rem h-3rem"></p-button>
            <p-badge *ngIf="unreadCount() > 0" [value]="unreadCount().toString()" severity="danger" 
               styleClass="absolute top-0 right-0" [style]="{'min-width': '1rem', 'height': '1rem', 'line-height': '1rem'}"></p-badge>
         </div>

         <p-popover #op styleClass="w-25rem">
            <div class="flex flex-column gap-3 p-3">
               <div class="flex justify-content-between align-items-center">
                  <span class="font-bold text-lg">Notificaciones</span>
                  <p-button *ngIf="unreadCount() > 0" label="Marcar todo como leído" link="true" 
                     (onClick)="markAllAsRead()" styleClass="p-0 text-sm"></p-button>
               </div>
               
               <div class="flex flex-column gap-2" style="max-height: 400px; overflow-y: auto">
                  <div *ngIf="notifications().length === 0" class="text-center p-3 text-500">
                     No tienes notificaciones
                  </div>
                  
                  <div *ngFor="let notification of notifications()" 
                     class="flex align-items-start gap-3 p-2 border-round hover:surface-100 cursor-pointer transition-colors"
                     [ngClass]="{'surface-50': !notification.isRead}"
                     (click)="handleNotificationClick(notification)">
                     <i [class]="getNotificationIcon(notification.type) + ' text-xl mt-1'"></i>
                     <div class="flex flex-column gap-1 flex-1">
                        <div class="flex justify-content-between align-items-start">
                           <span class="font-bold text-900" [ngClass]="{'text-700': notification.isRead}">
                              {{ notification.title }}
                           </span>
                           <span class="text-xs text-500">{{ notification.createdAt | date:'short' }}</span>
                        </div>
                        <p class="m-0 text-700 text-sm line-height-3" [ngClass]="{'text-500': notification.isRead}">
                           {{ notification.message }}
                        </p>
                     </div>
                     <div *ngIf="!notification.isRead" class="w-1rem h-1rem border-circle bg-blue-500 align-self-center"></div>
                  </div>
               </div>
            </div>
         </p-popover>

         <p-button [icon]="isDarkMode() ? 'pi pi-sun' : 'pi pi-moon'" [text]="true" [rounded]="true"
            (click)="toggleTheme()" styleClass="text-900 w-3rem h-3rem"></p-button>

         <!-- Separator -->
         <div class="h-2rem w-1px surface-300 mx-2 hidden md:block"></div>

         <!-- User Profile -->
         <div class="flex align-items-center gap-2 cursor-pointer border-round p-1 hover:surface-100 transition-colors" (click)="userMenu.toggle($event)">
             <p-avatar [label]="userInitials" shape="circle" styleClass="bg-primary text-white font-bold"></p-avatar>
             <div class="hidden md:flex flex-column">
                 <span class="font-semibold text-sm text-900 line-height-2">{{ currentUser()?.name }}</span>
                 <span class="text-xs text-600 line-height-2">{{ currentUser()?.email }}</span>
             </div>
             <i class="pi pi-chevron-down text-600 text-xs"></i>
         </div>
         <p-menu #userMenu [model]="userMenuItems" [popup]="true"></p-menu>
      </div>
   </p-toolbar>

   <p-drawer [visible]="isDrawerOpen" (visibleChange)="onDrawerVisibleChange($event)" [modal]="true"
      [showCloseIcon]="true" styleClass="w-20rem shadow-6">
      <ng-template pTemplate="header">
         <div class="flex align-items-center gap-2">
            <img src="assets/claro-media-logo.png" alt="Logo" class="h-2rem">
            <span class="font-bold text-xl text-900">Menú</span>
         </div>
      </ng-template>

      <div class="flex flex-column h-full">
         <div *ngIf="loading()" class="flex justify-content-center p-4">
            <i class="pi pi-spin pi-spinner text-2xl text-primary"></i>
         </div>

         <div *ngIf="error()" class="p-4 text-red-500 text-center">
            {{ error() }}
         </div>

         <ul class="list-none p-0 m-0 flex-grow-1 overflow-y-auto" *ngIf="!loading() && !error()">
            <ng-container *ngFor="let item of menuItems()">
               <ng-container *ngIf="hasPermission(item)">

                  <li *ngIf="item.children && item.children.length > 0" class="mb-1">
                     <div pRipple (click)="toggleSubmenu(item.id)"
                        class="p-3 flex align-items-center justify-content-between text-700 cursor-pointer border-round hover:surface-100 transition-duration-150 transition-colors w-full">
                        <span class="flex align-items-center gap-3">
                           <i [class]="getIconName(item.icon) + ' text-lg'"></i>
                           <span class="font-medium">{{ item.label }}</span>
                        </span>
                        <i class="pi pi-chevron-down text-sm transition-duration-200"
                           [ngClass]="{'rotate-180': isExpanded(item.id)}"></i>
                     </div>
                     <ul *ngIf="isExpanded(item.id)"
                        class="list-none py-0 pl-3 pr-0 m-0 overflow-y-hidden transition-all transition-duration-400 transition-ease-in-out fadein animation-duration-200">
                        <li *ngFor="let child of item.children">
                           <a pRipple (click)="onMenuClick(child)" *ngIf="hasPermission(child)"
                              class="flex align-items-center cursor-pointer p-3 border-round text-600 hover:surface-100 transition-duration-150 transition-colors w-full">
                              <i [class]="getIconName(child.icon) + ' mr-3 text-lg'"></i>
                              <span class="font-medium">{{ child.label }}</span>
                           </a>
                        </li>
                     </ul>
                  </li>
                  
                  <li *ngIf="!item.children || item.children.length === 0" class="mb-1">
                     <a pRipple (click)="onMenuClick(item)"
                        class="p-3 flex align-items-center cursor-pointer border-round text-700 hover:surface-100 transition-duration-150 transition-colors w-full">
                        <span class="flex align-items-center gap-3">
                           <i [class]="getIconName(item.icon) + ' text-lg'"></i>
                           <span class="font-medium">{{ item.label }}</span>
                        </span>
                     </a>
                  </li>

               </ng-container>
            </ng-container>
         </ul>
      </div>
   </p-drawer>

   <div class="flex-grow-1 p-4" style="margin-top: 4rem;">
      <router-outlet></router-outlet>
   </div>
</div>
